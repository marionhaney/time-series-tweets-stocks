---
title: "Modeling Tesla Stock Price Using Tweets"
author: "Divya Rao, Jay Chung, Marion Haney, Tilina Alzaben"
documentclass: article
geometry: margin=1in
output:
  bookdown::pdf_document2:
    toc: no
    includes:  
      in_header: preamble-latex.tex
---

```{r, include=FALSE}
###########################
# STYLE EDITS: IGNORE THIS
###########################

# normally you'll want to include this with the libraries at the beginning of your document
knitr::opts_chunk$set(message = FALSE) # include this if you don't want markdown to knit messages
knitr::opts_chunk$set(warning = FALSE) # include this if you don't want markdown to knit warnings
knitr::opts_chunk$set(echo = FALSE) # set echo = FALSE to hide code from output

```

# Executive summary {-}

...

# Introduction

Research Questions:
- Do the frequency and sentiment of Tesla-related Tweets have a relationship with Tesla’s stock close price?
- Can we use frequency and sentiment of Tweets mentioning Tesla to forecast Tesla’s stock price?

Data
For this analysis, we utilized two datasets from Kaggle.  
Twitter Tweets: 80793 Tweets, 25 companies
Stock Market Data: Daily close price of stock for same 25 companies
Companies are the top 25 “most watched” stocks from Yahoo Finance
Filtered to only Tweets that mention Tesla or TSLA stock
46% of the Tweets in data mentioned TSLA (37422 Tweets)
Date range: 09-30-2021 to 09-30-2022 (excluding weekends)


...

# Methods

Text example that references Table \@ref(tab:table-example).

```{r table-example}
library(pander)
library(tidyverse)
library(reshape2)
library(kableExtra)
library(knitr)

# Titanic table

titantic <- read_csv(paste0("https://raw.githubusercontent.com/",
                            "benjaminleroy/stat315summer_data/",
                            "master/assignments/assignment03/titanic.csv"))
titantic %>% group_by(Pclass, Sex) %>%
  summarize(t = n()) %>% dcast(Pclass ~ Sex) %>%
  rename(`Passenger class` = Pclass) %>%
  kable(format = "latex",
        caption = paste("Passenger gender and class divisions on the Titanic.",
                        "More 3rd class passengers were males seeking a",
                        "better life."),
        booktabs = T) %>%
  kable_styling(latex_options = "HOLD_position")
```


```{r}
suppressMessages(library(tidyverse))
suppressMessages(library(lubridate))
suppressMessages(library(tidytext))
suppressMessages(library(textdata))
suppressMessages(library(dplyr))
suppressMessages(library(quantmod))
suppressMessages(library(fGarch))

df <- read.csv("/Users/divyarao/time-series-tweets-stocks/data/stock_tweets.csv")  %>%
  filter(Stock.Name == 'TSLA') %>%
  mutate(Tweet.ID = row_number()) %>%
  dplyr::select(Tweet.ID, Date, Tweet)
dim(df)
names(df)

df$Date <-  ymd(substr(df$Date, 1, 10))
tweets <- data.frame(df)

```


```{r}
# Sentiment analysis
map_bing_sentiment <- function(sentiment) {
  ifelse(sentiment %in% c("positive"), 1, ifelse(sentiment %in% c("negative"), -1, 0))
}

map_nrc_sentiment <- function(sentiment) {
  nrc_positive_sentiments <- c("positive", "anticipation", "surprise", "trust", "joy")
  nrc_negative_sentiments <- c("negative", "anger", "disgust", "fear", "sadness")
  ifelse(sentiment %in% nrc_positive_sentiments, 1,
         ifelse(sentiment %in% nrc_negative_sentiments, -1, 0))
}

tweet_tokens <- tweets %>%
  unnest_tokens(word, Tweet)  

sentiments <- get_sentiments("bing") %>% mutate(sentiment_score = map_bing_sentiment(sentiment))
#sentiments <- get_sentiments("afinn") %>% mutate(sentiment_score = value)
#sentiments <- get_sentiments("nrc") %>% mutate(sentiment_score = map_nrc_sentiment(sentiment))

tweets_sentiment <- tweet_tokens %>%
  inner_join(sentiments, by = "word", relationship = "many-to-many")  %>%
  distinct(Tweet.ID, Date, word, .keep_all = TRUE)

tweets_sentiment_summary <- tweets_sentiment %>%
  group_by(Tweet.ID, Date) %>%  
  summarise(sentiment_score = sum(sentiment_score, na.rm = TRUE), .groups = "drop")

daily_sentiment <- tweets_sentiment_summary  %>%
  group_by(Date) %>%
  summarise(daily_sentiment = mean(sentiment_score))
```

Most positive Tweet
```{r}
most_pos_twid <- 
  tweets_sentiment_summary[which.max(tweets_sentiment_summary$sentiment_score),"Tweet.ID"]
tweets[most_pos_twid$Tweet.ID,]$Tweet
max(tweets_sentiment_summary$sentiment_score)
```

Most negative Tweet
```{r}
most_neg_twid <- 
  tweets_sentiment_summary[which.min(tweets_sentiment_summary$sentiment_score),"Tweet.ID"]
tweets[most_neg_twid$Tweet.ID,]$Tweet
min(tweets_sentiment_summary$sentiment_score)
```

Most positive day
```{r}
daily_sentiment[which.max(daily_sentiment$daily_sentiment),]
```

Most negative day
```{r}
daily_sentiment[which.min(daily_sentiment$daily_sentiment),]
```

```{r}
df <- read.csv("/Users/divyarao/time-series-tweets-stocks/data/stock_yfinance_data.csv") %>%
  filter(Stock.Name == 'TSLA') %>%
  dplyr::select(Date, Adj.Close)
df$Date <- as.Date(df$Date)
head(df)
df$Returns <- c(diff(log(df$Adj.Close)), NA)
stock <- data.frame(df)
stock <- stock %>% na.omit()
```
```{r}
plot(stock$Returns, main="TSLA Log Returns")
par(mfrow=c(1,1))
acf(stock$Returns, main="ACF of TSLA Log Returns", na.action = na.pass)
pacf(stock$Returns, main="PACF of TSLA Log Returns", na.action = na.pass)
acf(stock$Returns^2, main="ACF of TSLA Log Returns^2", na.action = na.pass)
pacf(stock$Returns^2, main="PACF of TSLA Log Returns^2", na.action = na.pass)
```
```{r}
suppressWarnings(library(forecast))

arma_rt_squared <- auto.arima(stock$Returns^2, max.p = 5, max.q = 5, max.order = 10,
                              stationary = T, seasonal = F, trace = F,
                              stepwise = F, approximation = F)
summary(arma_rt_squared)
```

```{r}
stock_ts <- ts(stock$Returns, 
               start=c(2021,9), 
               frequency=365)  
garch_model <- garchFit(~ garch(1,1), data=stock_ts, trace=FALSE)
summary(garch_model)

par(mfrow=c(1,1))
plot(garch_model, which = 1)
plot(garch_model, which = 2)

par(mfrow=c(1,1))
```

#### Combine data from stock, daily_sentiment

```{r}
combined_data <- left_join(stock, daily_sentiment, by = "Date")
cor(combined_data$daily_sentiment, combined_data$Returns, use = "complete.obs")

model <- lm(Returns ~ daily_sentiment, data = combined_data)
summary(model)
```

```{r}
suppressMessages(library(vars))
df <- combined_data[, c("Returns", "daily_sentiment")]
# VARselect
lag.select <- VARselect(df, 
                        lag.max = 30, 
                        type = "both")
optimal.lags <- lag.select$selection['AIC(n)']

# Fit the VAR model
var.model <- VAR(df, p = optimal.lags)

summary(var.model)
```

```{r}
suppressMessages(library(dplyr))

combined_data <- combined_data %>%
  arrange(Date) %>%
  mutate(
    Returns_l1 = lag(Returns, 1),
    Returns_l2 = lag(Returns, 2),
    daily_sentiment_l1 = lag(daily_sentiment, 1),
    daily_sentiment_l2 = lag(daily_sentiment, 2)
  )

model <- lm(Returns ~ Returns_l1 + Returns_l2 + daily_sentiment + daily_sentiment_l1 + daily_sentiment_l2, data = combined_data)

summary(model)
```

```{r}
model <- lm(daily_sentiment ~ Returns + Returns_l1 + Returns_l2 + daily_sentiment_l1 + daily_sentiment_l2, data = combined_data)

summary(model)
```


# Results

Text example that references Figure \@ref(fig:fig-example).

```{r fig-example, fig.cap = "Survival rates across different passenger classes. This figure does not tell the full story as Table 1 shows that more of the lower class passengers were male."}

# Titanic visual

titantic %>% ggplot() +
  geom_bar(aes(fill = factor(Survived, 
                             levels = c(0,1), 
                             labels = c("No", "Yes")), Pclass), 
           position = "fill") +
  scale_fill_manual(values = c("black", "lightblue")) +
  labs(fill = "Survived",
       y = "Proportion",
       x = "Passenger class",
       title = "Survival rates by passenger class")
```

# Discussion

## Conclusion
Stock price cannot be predicted based on the current or lagged 1 values of 
daily sentiment or lagged 1 or 2 values for returns. The coefficient for lagged 
2 daily sentiment is statistically significant but too small to be useful. Daily 
sentiment cannot be predicted based on current stock price but CAN be explained 
by the lagged 1 or 2 values of the stock price or daily sentiment. 


## Future Work
- Stock prices are expected to increase over time. 
- Incorporate indicator of overall market performance into the model.
- Negative Tweets/news events may only correspond to temporary dips in stock price, suggesting longer lags should be used for forecasting.
- Additional analysis with Tweet engagement along with sentiment score.
- VAR did not determine number of Tweets per day using sentiment score useful, but engagement levels (likes, retweets, views, etc.) may be more predictive of stock price.


...

\pagebreak

# Appendix {-}

Notice how the appendix below gathers all the code blocks above and nicely pastes them together.

```{r ref.label=knitr::all_labels(), echo = T, eval = F}
```